name: Build/release

on:
  push:
    branches:
      - '**'
    tags:
      - v*
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    permissions:
      contents: write
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for consistency

      - name: Check for changes in application directory
        id: check_changes
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_BEFORE: ${{ github.event.before }}
          GITHUB_SHA: ${{ github.sha }}
        run: node .github/workflows/js/check-application-changes.js

      - name: Setup Bun
        if: steps.check_changes.outputs.has_application_changes == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.8

      - name: Cache Bun dependencies
        if: steps.check_changes.outputs.has_application_changes == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
          key: bun-deps-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-deps-${{ runner.os }}-

      - name: Install Dependencies
        if: steps.check_changes.outputs.has_application_changes == 'true'
        shell: bash
        run: |
          bun install --frozen-lockfile --linker=hoisted && cp -r ./node_modules/electron ./application/node_modules/electron && mkdir -p ./updater/node_modules && cp -r ./node_modules/electron ./updater/node_modules/electron

      - name: Build Release Client
        if: steps.check_changes.outputs.has_application_changes == 'true'
        run: cd application && bun run electron-pack

      - name: Build Release Updater
        if: steps.check_changes.outputs.has_application_changes == 'true'
        run: cd updater && bun run electron-pack

      - name: Zip for Windows Portable
        if: matrix.os == 'windows-latest' && steps.check_changes.outputs.has_application_changes == 'true'
        run: |
          Compress-Archive -Path application/dist/win-unpacked/* -Destination application/dist/OpenGameInstaller-Portable.zip

      - name: Generate Windows blockmaps
        if: matrix.os == 'windows-latest' && steps.check_changes.outputs.has_application_changes == 'true'
        shell: bash
        run: |
          bunx --bun app-builder-bin blockmap --input "application/dist/OpenGameInstaller-Portable.zip" --output "application/dist/OpenGameInstaller-Portable.zip.blockmap"
          bunx --bun app-builder-bin blockmap --input "updater/dist/OpenGameInstaller-Setup.exe" --output "updater/dist/OpenGameInstaller-Setup.exe.blockmap"

      - name: Upload Windows Assets as Artifacts
        if: matrix.os == 'windows-latest' && steps.check_changes.outputs.has_application_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: windows-assets
          path: |
            application/dist/OpenGameInstaller-Portable.zip
            application/dist/OpenGameInstaller-Portable.zip.blockmap
            updater/dist/OpenGameInstaller-Setup.exe
            updater/dist/OpenGameInstaller-Setup.exe.blockmap

      - name: Generate Linux blockmaps
        if: matrix.os == 'ubuntu-latest' && steps.check_changes.outputs.has_application_changes == 'true'
        shell: bash
        run: |
          bunx --bun app-builder-bin blockmap --input "application/dist/OpenGameInstaller-linux-pt.AppImage" --output "application/dist/OpenGameInstaller-linux-pt.AppImage.blockmap"
          bunx --bun app-builder-bin blockmap --input "updater/dist/OpenGameInstaller-Setup.AppImage" --output "updater/dist/OpenGameInstaller-Setup.AppImage.blockmap"

      - name: Upload Linux Assets as Artifacts
        if: matrix.os == 'ubuntu-latest' && steps.check_changes.outputs.has_application_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: linux-assets
          path: |
            updater/dist/OpenGameInstaller-Setup.AppImage
            updater/dist/OpenGameInstaller-Setup.AppImage.blockmap
            application/dist/OpenGameInstaller-linux-pt.AppImage
            application/dist/OpenGameInstaller-linux-pt.AppImage.blockmap
  release:
    permissions:
      contents: write
    name: Create Github Release
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history to access tag annotations

      - name: Extract commit message body
        id: commit_body
        run: |
          echo "GITHUB_REF: ${{ github.ref }}"
          echo "GITHUB_REF_NAME: ${{ github.ref_name }}"
          git fetch --depth=1 origin +refs/tags/*:refs/tags/*
          # For tags, first check if it's an annotated tag
          TAG_TYPE=$(git cat-file -t "${{ github.ref_name }}")
          echo "TAG_TYPE: $TAG_TYPE"

          if [[ "$TAG_TYPE" == "tag" ]]; then
            # Annotated tag - get the tag message
            TAG_MESSAGE=$(git tag -l --format='%(contents)' "${{ github.ref_name }}" | sed '/^$/d' | sed '/-----BEGIN PGP SIGNATURE-----/,$d')
            echo "ANNOTATED TAG_MESSAGE FOUND: $TAG_MESSAGE"
            if [[ -n "$TAG_MESSAGE" && "$TAG_MESSAGE" != "" ]]; then
              # get the tagline of the update from the tag message's first line
              COMMIT_BODY=$(echo "$TAG_MESSAGE" | tail -n +2)
              TAGLINE=$(echo "$TAG_MESSAGE" | head -n 1)
              echo "TAGLINE: $TAGLINE"
            else
              # Even annotated tags might have empty messages, fallback to commit
              COMMIT_MESSAGE=$(git log -1 --pretty=format:"%B" "${{ github.ref_name }}")
              COMMIT_BODY=$(echo "$COMMIT_MESSAGE" | tail -n +2)
              # get the tagline of the update from the commit message's first line
              TAGLINE=$(echo "$COMMIT_MESSAGE" | head -n 1)
              echo "TAGLINE: $TAGLINE"
            fi
          else
            # Lightweight tag - use the commit message it points to
            echo "LIGHTWEIGHT TAG - using commit message"
            COMMIT_MESSAGE=$(git log -1 --pretty=format:"%B" "${{ github.ref_name }}")
            COMMIT_BODY=$(echo "$COMMIT_MESSAGE" | tail -n +2)
            # get the tagline of the update from the commit message's first line
            TAGLINE=$(echo "$COMMIT_MESSAGE" | head -n 1)
            echo "TAGLINE: $TAGLINE"
          fi
          # Convert HTML header tags in body to markdown so GitHub release renders them
          COMMIT_BODY=$(echo "$COMMIT_BODY" | sed -e 's/<\/h6>//g' -e 's/<\/h5>//g' -e 's/<\/h4>//g' -e 's/<\/h3>//g' -e 's/<\/h2>//g' -e 's/<\/h1>//g' -e 's/<h6>/###### /g' -e 's/<h5>/##### /g' -e 's/<h4>/#### /g' -e 's/<h3>/### /g' -e 's/<h2>/## /g' -e 's/<h1>/# /g')
          # Strip HTML tags from tagline for plain-text release name
          TAGLINE=$(echo "$TAGLINE" | sed 's/<[^>]*>//g')
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "tagline=$TAGLINE" >> $GITHUB_OUTPUT

      - name: Get updater version
        id: updater_version
        run: |
          UPDATER_VERSION=$(grep -o '"version": *"[^"]*"' updater/package.json | grep -o '[0-9.]*')
          echo "version=$UPDATER_VERSION" >> $GITHUB_OUTPUT
          echo "Updater version: $UPDATER_VERSION"

      - name: Download Windows Assets
        uses: actions/download-artifact@v4
        with:
          name: windows-assets
          path: assets
          merge-multiple: true

      - name: Download Linux Assets
        uses: actions/download-artifact@v4
        with:
          name: linux-assets
          path: assets
          merge-multiple: true

      - name: Flatten assets structure
        run: |
          mkdir -p assets-flat
          find assets -type f -name "*.zip" -exec cp {} assets-flat/ \;
          find assets -type f -name "*.blockmap" -exec cp {} assets-flat/ \;
          find assets -type f -name "*.exe" -exec cp {} assets-flat/ \;
          find assets -type f -name "*.AppImage" -exec cp {} assets-flat/ \;
          ls -la assets-flat/

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ format('{0} - {1}', github.ref_name, steps.commit_body.outputs.tagline) }}
          body: |
            # Release ${{ github.ref_name }}
            ${{ steps.commit_body.outputs.body }}

            **Full Changelog:** https://github.com/Nat3z/OpenGameInstaller/commits/${{ github.ref_name }}
            # How To Install

            For the simplest installation, download the OpenGameInstaller-Setup.exe file and run it. **If you're on Steam Deck, download the OpenGameInstaller-Setup.AppImage file.** It includes an auto-updater to keep OpenGameInstaller up-to-date.

            ### Release Details

            Setup Version: ${{ steps.updater_version.outputs.version }}
            Application Version: ${{ github.ref_name }}
          draft: false
          prerelease: true
          files: |
            assets-flat/OpenGameInstaller-Portable.zip
            assets-flat/OpenGameInstaller-Portable.zip.blockmap
            assets-flat/OpenGameInstaller-Setup.exe
            assets-flat/OpenGameInstaller-Setup.exe.blockmap
            assets-flat/OpenGameInstaller-Setup.AppImage
            assets-flat/OpenGameInstaller-Setup.AppImage.blockmap
            assets-flat/OpenGameInstaller-linux-pt.AppImage
            assets-flat/OpenGameInstaller-linux-pt.AppImage.blockmap
