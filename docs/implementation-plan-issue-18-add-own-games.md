# Implementation Plan: Issue #18 – Add Own Games

## Summary

**Issue:** Allow users to add games that are already installed on their system to the OGI library, so they can launch and manage them from the same interface as games installed via addons.

**Scope:** New UI to add a local game (name, executable path, working directory, optional art), backend support for generating unique IDs for “own” games, and reuse of the existing `app:insert-app` flow. No changes to ogi-addon types.

---

## 1. Files to Modify / Add

### Backend (Electron)

| File | Action |
|------|--------|
| `application/src/electron/handlers/library-handlers.ts` | Add IPC handler to generate next custom app ID; optionally validate paths in insert-app for “own” games. |
| `application/src/electron/handlers/helpers.app/library.ts` | Add `getNextCustomAppId(): number` (or equivalent) to allocate negative IDs for custom games. |
| `application/src/electron/preload.mts` | Expose new API (e.g. `generateCustomAppId`) on `app` if the ID is generated by the main process. |

### Frontend

| File | Action |
|------|--------|
| `application/src/frontend/views/LibraryView.svelte` | Add “Add game” entry point (e.g. button in “All Games” header or empty state). |
| **New:** `application/src/frontend/components/AddOwnGameModal.svelte` (or under `modal/`) | New modal: form (name, executable path, cwd, optional version, optional images) + optional “Browse” for executable/directory, submit → build `LibraryInfo` and call `insertApp`. |
| `application/src/frontend/global.d.ts` | Declare new IPC method if added (e.g. `generateCustomAppId`). |

### Optional / Follow-ups

| File | Action |
|------|--------|
| `application/src/frontend/components/PlayPage.svelte` | For “own” games (e.g. by `storefront === 'local'` or `addonsource === 'ogi'`), hide or disable “View in Store” and optionally “Check for updates” / update UI. |
| `application/src/frontend/managers/AppUpdateManager.svelte` | Skip update check when `storefront === 'local'` (or equivalent) to avoid unnecessary addon calls. |

---

## 2. Specific Changes

### 2.1 Custom app ID scheme

- **Convention:** Use **negative** `appID` for user-added “own” games. Store/addon games keep positive IDs (e.g. Steam app IDs). This avoids collisions and makes “own” games easy to detect.
- **Allocation:** In `library.ts` (or equivalent):
  - List existing library files, parse `appID` from each.
  - Among negative IDs, take the minimum (e.g. -1, -2, -3).
  - Return `min - 1` for the next custom ID (e.g. currently -5 → return -6).
  - If no negative IDs exist, return -1.
- **Persistence:** No extra file; IDs are derived from existing `library/*.json` filenames (which equal `appID`).

### 2.2 New IPC (if ID is generated in main process)

- **Handler:** e.g. `app:generate-custom-app-id` → calls `getNextCustomAppId()`, returns `number`.
- **Preload:** Expose as `window.electronAPI.app.generateCustomAppId()` (or similar).
- **Frontend:** Before building `LibraryInfo` in Add Own Game flow, call this once to get the new `appID`.

Alternative: generate the ID in the frontend (e.g. negative timestamp or negative sequence stored in a small JSON file). Backend generation is preferred for a single source of truth and no risk of collision.

### 2.3 Add Own Game form (new modal)

- **Fields (required):**
  - **Game name** (text).
  - **Executable path** (text + “Browse” for file; use existing `fs.dialog.showOpenDialog` with `openFile`).
  - **Working directory** (text + “Browse” for directory; same as OOBE/ClientOptions).
- **Fields (optional):**
  - **Version** (text; can default to `"1.0.0"` or empty).
  - **Launch arguments** (text; default empty).
  - **Capsule image URL** (text; or later: local file picker). Can fallback to app favicon in Library/PlayPage if empty.
  - **Cover image URL** (optional).
- **Validation:**
  - Name non-empty.
  - Executable path non-empty and, if possible, check file exists (backend or frontend via existing fs API).
  - CWD: if empty, can default to executable’s directory (dirname of executable path) on submit.
- **Submit:**  
  - Get `appID` from `generateCustomAppId()`.  
  - Build `LibraryInfo`:  
    - `storefront: 'local'`, `addonsource: 'ogi'` (or similar constants).  
    - `capsuleImage` / `coverImage`: use URL if provided, else placeholder or favicon URL.  
    - `cwd`: user value or `path.dirname(launchExecutable)`.  
  - Call `window.electronAPI.app.insertApp(info)`.  
  - On success: show notification, close modal, refresh library (e.g. trigger same reload as after install). On failure: show error notification.

Reuse existing modal building blocks: `Modal`, `TitleModal`, `SectionModal`, `InputModal` (with `type: 'file'` / `'folder'` for path fields), `ButtonModal`, `CloseModal`.

### 2.4 Library view entry point

- In **LibraryView.svelte**, in the “All Games” section header (next to the search box) or in the empty state when there are no games:
  - Add a button, e.g. “Add game” or “Add installed game”.
  - Click opens the new Add Own Game modal (e.g. `showAddOwnGameModal = true` and render `AddOwnGameModal`).
- After a successful add, the library list is already driven by `getAllApps()`; ensure the view refreshes (e.g. call `reloadLibrary()` or equivalent after closing the modal on success).

### 2.5 insert-app behavior (existing)

- **No change required** for the core flow: `app:insert-app` already accepts a full `LibraryInfo` and optional `redistributables`. For “own” games we do not send redistributables.
- **Linux:** Existing logic adds the game to Steam via steamtinkerlaunch and sets `launchArguments` with `WINEPREFIX=...`. Same flow applies to custom games (name, version, launchExecutable, cwd).
- **Windows:** No redistributables; game is just written to library and internals. No change.
- Optional: in `app:insert-app`, if `storefront === 'local'`, skip redistributable handling if any is ever sent for local games.

### 2.6 PlayPage / update check behavior (optional but recommended)

- In **PlayPage.svelte**, where “View in Store” is shown: if `libraryInfo.storefront === 'local'` (or `addonsource === 'ogi'`), hide the “View in Store” button or show “Added locally” instead of opening the store.
- In **AppUpdateManager.svelte**, when iterating library for `checkForUpdates`: skip entries with `storefront === 'local'` so addons are not asked for update info for non-addon games.

---

## 3. How This Fits the Existing Architecture

- **Data model:** Same `LibraryInfo` (ogi-addon). Only the origin of the entry changes: addon vs user-added. Using `storefront: 'local'` and `addonsource: 'ogi'` keeps addon code unchanged while allowing the UI to treat “own” games differently (e.g. no store link, no addon update check).
- **Library CRUD:** Existing handlers are reused:
  - `app:insert-app` – add entry.
  - `app:get-all-apps` – list (already includes all library files).
  - `app:launch-game` – launch by `appID` (same for custom IDs).
  - `app:remove-app` – remove by `appID`.
  - `app:update-app-version` – can be used later if you allow editing custom games (e.g. change path or version).
- **Linux/Proton:** addGameToSteam + getNonSteamGameAppID + WINEPREFIX logic already work with any name/version/executable/cwd; no change needed for “own” games.
- **UI patterns:** Same modal and input components as elsewhere (ConfigurationModal, OOBE, Debug insert-app); same fs.dialog for path picking; same notification and library refresh patterns.

---

## 4. Edge Cases and Considerations

| Topic | Suggestion |
|-------|------------|
| **ID collision** | Only allocate negative IDs for custom games; store/addon IDs remain positive. Backend generates next negative ID from existing library so collisions cannot occur. |
| **Invalid paths** | Validate executable path (and optionally cwd) before or inside `insert-app`. If file not found, return a clear error and do not add to library. Frontend can show validation errors in the modal. |
| **Executable vs script** | On Linux, user might pick a `.sh` or binary; on Windows, `.exe`. Avoid hardcoding extensions; just ensure the chosen file exists and is writable/readable if needed. |
| **CWD default** | If user leaves “Working directory” empty, set `cwd` to the directory of the selected executable (dirname) so launch works without requiring the user to fill it. |
| **Capsule/cover image** | Allow optional URL. If empty, LibraryView/PlayPage already have fallback (e.g. favicon). Optional: later support “local file” for art (would require path → in-app URL or base64). |
| **Launch arguments** | Optional field; default to empty. Existing launch logic already supports `%command%` and optional args. |
| **macOS** | Same insert-app flow; addGameToSteam is Linux-specific. On macOS, no Steam shortcut is added today; “own” games still get a library entry and launch via exec in cwd. |
| **Removing / re-adding** | Remove works via existing `app:remove-app`. Re-adding the same game will get a new negative ID; no need to “merge” with a previous entry. |
| **Updates** | “Own” games are not updated by addons. Either hide “Check for updates” for them or show “Not available for locally added games.” |
| **Store link** | Hide or disable “View in Store” for `storefront === 'local'` so we don’t open a store page that doesn’t exist for this entry. |

---

## 5. Implementation Order

1. **Backend:** Add `getNextCustomAppId()` in `library.ts` and IPC `app:generate-custom-app-id`; expose in preload and `global.d.ts`.
2. **Frontend:** Implement `AddOwnGameModal.svelte` (form + validation + submit with `insertApp` + refresh).
3. **LibraryView:** Add “Add game” button and wire modal open/close and library refresh.
4. **Optional:** PlayPage and AppUpdateManager handling for `storefront === 'local'`.
5. **Manual testing:** Add a game on Windows and Linux (with Steam/Proton if applicable), launch, remove; test empty state and validation.

---

## 6. Summary Table

| Area | Change |
|------|--------|
| **Backend** | Custom app ID generator (negative IDs); optional path validation in insert-app. |
| **Frontend** | New Add Own Game modal; “Add game” in LibraryView; optional PlayPage/AppUpdateManager guards for local games. |
| **Data** | Same `LibraryInfo`; `storefront: 'local'`, `addonsource: 'ogi'` for own games. |
| **IPC** | New: `app:generate-custom-app-id`. Existing: `app:insert-app`, `app:get-all-apps`, etc. |

This plan keeps addon and store logic unchanged, reuses existing library and launch flows, and limits new code to ID generation, one new modal, and small UI branches for “own” games.
